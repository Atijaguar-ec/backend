
services:

  mysql:
    image: mysql:8.0.35
    container_name: ${CONTAINER_NAME_DB:-inatrace-mysql-dev}
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DATABASE_NAME}
      - MYSQL_USER=${DATASOURCE_USERNAME}
      - MYSQL_PASSWORD=${DATASOURCE_PASSWORD}
    volumes:
      - ${DB_VOLUME}:/var/lib/mysql
    networks:
      - backend
    ports:
      - "${HOST_PORT_DB:-3306}:3306"
    restart: always

  backend:
    image: ${IMAGE_NAME}:${TAG}
    container_name: ${CONTAINER_NAME_BE:-inatrace-be-dev}
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - SERVER_PORT=${SERVER_PORT:-8080}
      - INATRACE_DATABASE_NAME=${DATABASE_NAME}
      - INATRACE_DATABASE_HOSTNAME=${CONTAINER_NAME_DB:-inatrace-mysql-dev}
      - SPRING_DATASOURCE_USERNAME=${DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DATASOURCE_PASSWORD}
      - INATRACE_FILESTORAGE_ROOT=${FILE_STORAGE_ROOT}
      - INATRACE_IMPORT_PATH=${IMPORT_PATH}
      - INATRACE_DOCUMENTS_ROOT=${DOCUMENTS_ROOT}
      - INATRACE_REQUESTLOG_TOKEN=${REQUESTLOG_TOKEN}
      - INATRACE_EXCHANGERATE_APIKEY=${EXCHANGERATE_APIKEY}
      - INATRACE_FE_URL=${FE_URL}
      - INATRACE_EMAILCONFIRMATION_URL=${FE_CONFIRM_URL}
      - INATRACE_PASSWORDRESET_URL=${FE_RESET_URL}
      - INATRACE_AGSTACK_EMAIL=${INATRACE_AGSTACK_EMAIL}
      - INATRACE_AGSTACK_PASSWORD=${INATRACE_AGSTACK_PASSWORD}
      - SPRING_MAIL_HOST=${SPRING_MAIL_HOST}
      - SPRING_MAIL_PORT=${SPRING_MAIL_PORT}
      - SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}
      - SPRING_MAIL_SMTP_AUTH=${SPRING_MAIL_SMTP_AUTH}
      - SPRING_MAIL_SMTP_SSL_ENABLE=${SPRING_MAIL_SMTP_SSL_ENABLE}
      - SPRING_MAIL_STARTTLS_ENABLE=${SPRING_MAIL_STARTTLS_ENABLE}
      - SPRING_MAIL_SMTP_CONNECTION_TIMEOUT=${SPRING_MAIL_SMTP_CONNECTION_TIMEOUT}
      - SPRING_MAIL_SMTP_TIMEOUT=${SPRING_MAIL_SMTP_TIMEOUT}
      - SPRING_MAIL_SMTP_WRITETIMEOUT=${SPRING_MAIL_SMTP_WRITETIMEOUT}
      - SPRING_MAIL_DEBUG=${SPRING_MAIL_DEBUG}
      - INATRACE_MAIL_TEMPLATE_FROM=${INATRACE_MAIL_TEMPLATE_FROM}
      - INATRACE_MAIL_REDIRECT=${INATRACE_MAIL_REDIRECT}
      - INATRACE_MAIL_SENDING_ENABLED=${INATRACE_MAIL_SENDING_ENABLED}
      # Admin user configuration for initial setup
      - INATRACE_ADMIN_EMAIL=${INATRACE_ADMIN_EMAIL}
      - INATRACE_ADMIN_PASSWORD=${INATRACE_ADMIN_PASSWORD}
      - INATRACE_ADMIN_NAME=${INATRACE_ADMIN_NAME}
      - INATRACE_ADMIN_SURNAME=${INATRACE_ADMIN_SURNAME}
      - INATRACE_ADMIN_COMPANY_NAME=${INATRACE_ADMIN_COMPANY_NAME}
    volumes:
      - ${FILE_STORAGE_ROOT_VOL}:${FILE_STORAGE_ROOT}
      - ${IMPORT_PATH_VOL}:${IMPORT_PATH}
      - ${DOCUMENTS_ROOT_VOL}:${DOCUMENTS_ROOT}
    networks:
      - backend
    depends_on:
      - mysql
    ports:
      - "${HOST_PORT_BE:-8080}:${SERVER_PORT:-8080}"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:${SERVER_PORT:-8080}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always

networks:
  backend:
    external: true
    name: inatrace-backend-network