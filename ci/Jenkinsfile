// ============================================================================
// Pipeline de Despliegue Backend - Fortaleza del Valle
// Autor: Alvaro Sanchez
// Ãšltima actualizaciÃ³n: 2025-10-09 v2.1
// ============================================================================

pipeline {
  agent any

  options {
    skipDefaultCheckout(true)
    timeout(time: 40, unit: 'MINUTES')
    ansiColor('xterm')
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '10'))
    disableConcurrentBuilds()
    timestamps()
  }

  parameters {
    choice(
      name: 'BRANCH',
      choices: ['staging', 'main'],
      description: 'Rama a desplegar (stagingâ†’test, mainâ†’prod)'
    )
    booleanParam(
      name: 'SKIP_TESTS',
      defaultValue: false,
      description: 'âš ï¸ Omitir pruebas (no recomendado para producciÃ³n)'
    )
    booleanParam(
      name: 'SKIP_DB_BACKUP',
      defaultValue: false,
      description: 'âš ï¸ Omitir backup de BD en producciÃ³n (no recomendado para producciÃ³n)' 
    )
  }

  environment {
    // ConfiguraciÃ³n de registro Docker
    REGISTRY = 'ghcr.io'
    
    // ConfiguraciÃ³n de despliegue
    COMPOSE_PROJECT_NAME = 'inatrace-backend-fortaleza'
    DOCKER_BUILDKIT = '1'
    COMPOSE_DOCKER_CLI_BUILD = '1'
    
    // Timeouts y reintentos
    HEALTH_CHECK_TIMEOUT = '120'
    HEALTH_CHECK_INTERVAL = '10'
    MAX_RETRIES = '3'
  }


  tools {
    jdk 'jdk-17'
    maven 'maven-3.9.11'
  }

  stages {
    // ========================================================================
    // STAGE 0: Checkout cÃ³digo fuente
    // ========================================================================
    stage('ğŸ“¥ Checkout') {
      steps {
        cleanWs()
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${params.BRANCH}"]],
          userRemoteConfigs: [[
            url: 'https://github.com/Atijaguar-ec/backend.git',
            credentialsId: 'github-pat'
          ]],
          extensions: [
            [$class: 'CloneOption', shallow: false, depth: 0, noTags: false]
          ]
        ])
      }
    }

    // ========================================================================
    // STAGE 1: InicializaciÃ³n y configuraciÃ³n
    // ========================================================================
    stage('ğŸ”§ InicializaciÃ³n') {
      steps {
        script {
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  INICIO DE DESPLIEGUE - FORTALEZA DEL VALLE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Rama: ${params.BRANCH}"
          echo "Usuario: ${env.BUILD_USER ?: 'Sistema'}"
          echo "Timestamp: ${new Date().format('yyyy-MM-dd HH:mm:ss z')}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        }
        
        script {
          // Extraer informaciÃ³n del repositorio (ya clonado por SCM)
          def remoteUrl = sh(script: 'git config --get remote.origin.url', returnStdout: true).trim()
          remoteUrl = remoteUrl.replaceAll(/\.git$/, '')
          remoteUrl = remoteUrl.replaceFirst(/^https?:\/\/github.com\//, '')
          remoteUrl = remoteUrl.replaceFirst(/^git@github.com:/, '')
          
          env.REPO_FULL_NAME = remoteUrl
          env.GIT_SHORT_SHA = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          env.GIT_COMMIT_MSG = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
          env.GIT_AUTHOR = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
          // Configurar variables segÃºn entorno
          env.IMAGE_REPOSITORY = env.REGISTRY.toLowerCase() + '/' + (env.REPO_FULL_NAME + '-inatrace').toLowerCase()
          env.DEPLOY_TAG = params.BRANCH == 'main' ? 'latest' : "test-${env.GIT_SHORT_SHA}"
          env.FORTALEZA_ENV = params.BRANCH == 'main' ? 'prod' : 'test'
          env.HEALTHCHECK_URL = params.BRANCH == 'main' ? 
            'https://inatrace.espam.edu.ec/api/actuator/health' : 
            'https://testinatrace.espam.edu.ec/api/actuator/health'
          env.COMPOSE_DIR = params.BRANCH == 'main' ? 
            'deploy/backend/prod/fortaleza' : 
            'deploy/backend/test/fortaleza'
          
          echo "\nğŸ“¦ InformaciÃ³n del Build :"
          echo "  - Repositorio: ${env.REPO_FULL_NAME}"
          echo "  - Commit: ${env.GIT_SHORT_SHA}"
          echo "  - Autor: ${env.GIT_AUTHOR}"
          echo "  - Mensaje: ${env.GIT_COMMIT_MSG}"
          echo "  - Imagen: ${env.IMAGE_REPOSITORY}:${env.DEPLOY_TAG}"
          echo "  - Entorno: ${env.FORTALEZA_ENV}"
        }
      }
    }

    // ========================================================================
    // STAGE 2: Pruebas y ValidaciÃ³n de Calidad
    // ========================================================================
    stage('ğŸ§ª Tests & Quality') {
      when {
        expression { return !params.SKIP_TESTS }
      }
      steps {
        script {
          echo "\nğŸ§ª Ejecutando pruebas unitarias e integraciÃ³n..."
          if (params.BRANCH == 'main' && params.SKIP_TESTS) {
            error("âŒ No se permiten despliegues a producciÃ³n sin pruebas")
          }
        }
        
        dir('.') {
          sh '''
            set -e
            echo "ğŸ“Š Ejecutando Maven verify..."
            mvn -B clean verify \
              -Dspring.profiles.active=test \
              -Dmaven.test.failure.ignore=false \
              -Djacoco.skip=false
            
            echo "âœ… Pruebas completadas exitosamente"
          '''
        }
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
        }
        failure {
          echo "âŒ Las pruebas fallaron. Abortando despliegue."
        }
      }
    }

    // ========================================================================
    // STAGE 3: ConstrucciÃ³n y PublicaciÃ³n de Imagen Docker
    // ========================================================================
    stage('ğŸ—ï¸ Build & Push Image') {
      steps {
        script {
          echo "\nğŸ—ï¸ Construyendo imagen Docker..."
        }
        
        dir('backend') {
          withCredentials([
            usernamePassword(credentialsId: 'ghcr-credentials', usernameVariable: 'GHCR_USER', passwordVariable: 'GHCR_TOKEN')
          ]) {
            sh '''
              set -e
              
              echo "ğŸ” Autenticando en GHCR..."
              echo $GHCR_TOKEN | docker login ghcr.io -u $GHCR_USER --password-stdin
              
              echo "ğŸ“¦ Compilando artefactos con Maven..."
              mvn -B clean package -DskipTests -Dmaven.javadoc.skip=true
              
              echo "ğŸ³ Construyendo imagen Docker..."
              docker build \
                --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                --build-arg VCS_REF=${GIT_SHORT_SHA} \
                --build-arg VERSION=${DEPLOY_TAG} \
                --label "org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
                --label "org.opencontainers.image.revision=${GIT_SHORT_SHA}" \
                --label "org.opencontainers.image.version=${DEPLOY_TAG}" \
                --label "org.opencontainers.image.source=https://github.com/${REPO_FULL_NAME}" \
                -t ${IMAGE_REPOSITORY}:${DEPLOY_TAG} \
                .
              
              echo "ğŸ“¤ Publicando imagen con tag: ${DEPLOY_TAG}"
              docker push ${IMAGE_REPOSITORY}:${DEPLOY_TAG}
              
              echo "ğŸ·ï¸ Etiquetando como latest..."
              docker tag ${IMAGE_REPOSITORY}:${DEPLOY_TAG} ${IMAGE_REPOSITORY}:latest
              docker push ${IMAGE_REPOSITORY}:latest
              
              echo "âœ… Imagen publicada exitosamente"
              docker images | grep ${IMAGE_REPOSITORY} | head -5
            '''
          }
        }
      }
      post {
        failure {
          echo "âŒ FallÃ³ la construcciÃ³n o publicaciÃ³n de la imagen"
        }
      }
    }

    // ========================================================================
    // STAGE 4: Backup de Base de Datos (solo producciÃ³n)
    // ========================================================================
    stage('ğŸ’¾ Database Backup') {
      when {
        allOf {
          expression { params.BRANCH == 'main' }
          expression { !params.SKIP_DB_BACKUP }
        }
      }
      steps {
        script {
          echo "\nğŸ’¾ Realizando backup de base de datos..."
          sh '''
            set -e
            CONTAINER_NAME="inatrace-mysql-prod-fortaleza"
            BACKUP_DIR="/opt/inatrace/backups"
            BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S)-pre-deploy.sql.gz"
            
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "ğŸ“¦ Creando backup en: ${BACKUP_DIR}/${BACKUP_FILE}"
              docker exec "${CONTAINER_NAME}" sh -c '
                mysqldump -u root -p"${MYSQL_ROOT_PASSWORD}" \
                  --single-transaction \
                  --quick \
                  --lock-tables=false \
                  "${MYSQL_DATABASE}" | gzip -9 > "/backups/'"${BACKUP_FILE}"'"
              '
              
              echo "ğŸ§¹ Limpiando backups antiguos (>14 dÃ­as)..."
              docker exec "${CONTAINER_NAME}" sh -c '
                find /backups -name "backup-*.sql.gz" -mtime +14 -delete
              '
              
              echo "âœ… Backup completado: ${BACKUP_FILE}"
            else
              echo "âš ï¸ Contenedor MySQL no encontrado, omitiendo backup"
            fi
          '''
        }
      }
    }
    
    // ========================================================================
    // STAGE 5: Despliegue en Fortaleza
    // ========================================================================
    stage('ğŸš€ Deploy Fortaleza') {
      steps {
        script {
          echo "\nğŸš€ Iniciando despliegue en entorno: ${env.FORTALEZA_ENV}"
          
          def envCredential = env.FORTALEZA_ENV == 'prod' ? 'fortaleza-env-prod' : 'fortaleza-env-staging'
          
          dir(env.COMPOSE_DIR) {
            withCredentials([file(credentialsId: envCredential, variable: 'ENVFILE')]) {
              sh '''
                set -e
                
                echo "ğŸ“‹ Preparando archivo .env..."
                cp $ENVFILE .env
                
                # Actualizar variables dinÃ¡micas en .env
                python3 - <<'PY'
import os
import sys
from pathlib import Path

try:
    env_path = Path('.env')
    if not env_path.exists():
        print("âŒ Archivo .env no encontrado", file=sys.stderr)
        sys.exit(1)
    
    lines = env_path.read_text().splitlines()
    updates = {
        'TAG': os.environ['DEPLOY_TAG'],
        'IMAGE_NAME': os.environ['IMAGE_REPOSITORY'],
    }
    
    for key, value in updates.items():
        found = False
        for idx, line in enumerate(lines):
            if line.startswith(f"{key}="):
                lines[idx] = f"{key}={value}"
                found = True
                break
        if not found:
            lines.append(f"{key}={value}")
    
    env_path.write_text('\n'.join(lines) + '\n')
    print(f"âœ… Archivo .env actualizado: TAG={updates['TAG']}")
except Exception as e:
    print(f"âŒ Error actualizando .env: {e}", file=sys.stderr)
    sys.exit(1)
PY
                
                echo "\nğŸ”— Verificando red Docker..."
                docker network inspect inatrace-backend-network >/dev/null 2>&1 || \
                  docker network create inatrace-backend-network
                
                echo "\nğŸ“¥ Descargando Ãºltima imagen..."
                docker-compose pull || true
                
                echo "\nğŸ”„ Desplegando servicios..."
                docker-compose up -d --remove-orphans --force-recreate
                
                echo "\nğŸ“Š Estado de contenedores:"
                docker-compose ps
                
                echo "\nâ³ Esperando que el backend estÃ© saludable..."
                RETRY_COUNT=0
                MAX_RETRIES=12
                SLEEP_TIME=10
                
                while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  
                  if curl -fsS --max-time 5 "${HEALTHCHECK_URL}" >/dev/null 2>&1; then
                    echo "âœ… Backend Fortaleza estÃ¡ saludable"
                    echo "\nğŸ“ˆ Logs recientes:"
                    docker-compose logs --tail=20 inatrace-be
                    exit 0
                  fi
                  
                  echo "â³ Intento ${RETRY_COUNT}/${MAX_RETRIES} - Esperando ${SLEEP_TIME}s..."
                  sleep $SLEEP_TIME
                done
                
                echo "\nâŒ Health check fallÃ³ despuÃ©s de ${MAX_RETRIES} intentos" >&2
                echo "\nğŸ“‹ Logs del contenedor:"
                docker-compose logs --tail=50 inatrace-be
                echo "\nğŸ“Š Estado de contenedores:"
                docker-compose ps
                exit 1
              '''
            }
          }
        }
      }
      post {
        success {
          script {
            echo "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… DESPLIEGUE EXITOSO - ${env.FORTALEZA_ENV.toUpperCase()}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Imagen: ${env.IMAGE_REPOSITORY}:${env.DEPLOY_TAG}"
            echo "Commit: ${env.GIT_SHORT_SHA}"
            echo "URL: ${env.HEALTHCHECK_URL}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          }
        }
        failure {
          script {
            echo "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âŒ DESPLIEGUE FALLIDO"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Revisa los logs arriba para mÃ¡s detalles"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          }
        }
      }
    }
  }
  
  post {
    always {
      script {
        echo "\nğŸ§¹ Limpieza post-despliegue..."
        sh '''
          # Logout de registros Docker
          docker logout ghcr.io || true
          
          # Limpiar imÃ¡genes huÃ©rfanas (opcional)
          docker image prune -f --filter "dangling=true" || true
        '''
      }
    }
    success {
      script {
        def duration = currentBuild.durationString.replace(' and counting', '')
        echo "\nğŸ‰ Pipeline completado exitosamente en ${duration}"
      }
    }
    failure {
      script {
        echo "\nâŒ Pipeline fallÃ³. Revisa los logs para mÃ¡s informaciÃ³n."
        // AquÃ­ puedes agregar notificaciones (Slack, email, etc.)
      }
    }
    unstable {
      echo "\nâš ï¸ Pipeline completado con advertencias"
    }
  }
}