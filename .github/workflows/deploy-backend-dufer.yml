# ============================================================================
# ü¶ê Backend CI/CD - DUFER (Staging + Production)
# ============================================================================
# Este workflow despliega el backend para DUFER (Camar√≥n)
# - Staging: inatrace-test.empacadoradufer.com/api
# - Production: inatrace.empacadoradufer.com/api
#
# Triggers:
# - staging branch ‚Üí deploy to staging
# - main branch ‚Üí deploy to production
# ============================================================================

name: ü¶ê Backend DUFER

on:
  push:
    branches: [staging, main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-dufer.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_quality:
        description: 'Skip quality checks'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-inatrace
  JAVA_VERSION: '17'
  # DUFER specific
  COMPANY_NAME: DUFER
  PRIMARY_PRODUCT_TYPE: SHRIMP

jobs:
  # ============================================================================
  # Quality
  # ============================================================================
  quality:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_quality }}
    permissions:
      contents: read
      checks: write
    services:
      mysql:
        image: mysql:8.0.35
        env:
          MYSQL_ROOT_PASSWORD: inatrace
          MYSQL_DATABASE: inatrace
          MYSQL_USER: inatrace
          MYSQL_PASSWORD: inatrace
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot" --health-interval=10s --health-timeout=5s --health-retries=10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      - name: üîç Run tests
        continue-on-error: true
        run: mvn clean test -B -Dspring.profiles.active=test

  # ============================================================================
  # Build
  # ============================================================================
  build:
    name: üèóÔ∏è Build & Push
    runs-on: ubuntu-latest
    needs: [quality]
    if: always() && !cancelled()
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      image-ref: ${{ steps.image_ref.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: üè∑Ô∏è Generate metadata
        id: meta
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            VERSION=$(grep -m1 '<version>' pom.xml | sed -E 's/.*<version>([^<]+)<\/version>.*/\1/' | sed 's/-SNAPSHOT//')
            TAG="dufer-v${VERSION}"
          else
            TAG="dufer-staging-${GITHUB_SHA::7}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "üè∑Ô∏è Generated tag: $TAG"

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: üîê Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Compute image ref
        id: image_ref
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: üèóÔ∏è Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.image_ref.outputs.image }}:${{ steps.meta.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ‚úÖ Build complete
        run: echo "üì¶ Image pushed - ${{ steps.image_ref.outputs.image }}:${{ steps.meta.outputs.tag }}"

  # ============================================================================
  # Deploy Staging
  # ============================================================================
  deploy-staging:
    name: üß™ Deploy DUFER Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/staging' || github.event.inputs.environment == 'staging'
    environment:
      name: dufer-staging
      url: https://inatrace-test.empacadoradufer.com
    steps:
      - uses: actions/checkout@v4

      - name: üîê Preflight
        run: |
          missing=0
          [ -z "${{ secrets.TEST_DUFER_HOST }}" ] && echo "‚ùå TEST_DUFER_HOST" && missing=1
          [ -z "${{ secrets.TEST_DUFER_USER }}" ] && echo "‚ùå TEST_DUFER_USER" && missing=1
          [ -z "${{ secrets.TEST_DUFER_PASSWORD }}" ] && echo "‚ùå TEST_DUFER_PASSWORD" && missing=1
          [ -z "${{ secrets.TEST_DUFER_DB_ROOT_PASSWORD }}" ] && echo "‚ùå TEST_DUFER_DB_ROOT_PASSWORD" && missing=1
          [ -z "${{ secrets.TEST_DUFER_DATASOURCE_PASSWORD }}" ] && echo "‚ùå TEST_DUFER_DATASOURCE_PASSWORD" && missing=1
          [ "$missing" -ne 0 ] && exit 1
          echo "‚úÖ All secrets present"

      - name: üìÅ Prepare remote directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TEST_DUFER_HOST }}
          username: ${{ secrets.TEST_DUFER_USER }}
          password: ${{ secrets.TEST_DUFER_PASSWORD }}
          script: |
            sudo mkdir -p /opt/inatrace/backend/test/dufer
            sudo chown -R $USER:$USER /opt/inatrace/backend/test/dufer

      - name: üì§ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_DUFER_HOST }}
          username: ${{ secrets.TEST_DUFER_USER }}
          password: ${{ secrets.TEST_DUFER_PASSWORD }}
          source: "ci/docker-compose.yml"
          target: "/opt/inatrace/backend/test/dufer/"
          strip_components: 1

      - name: üìù Prepare .env
        run: |
          IMAGE="${{ needs.build.outputs.image-ref }}"
          TAG="${{ needs.build.outputs.image-tag }}"
          DB_USER="${{ secrets.TEST_DUFER_DATASOURCE_USERNAME }}"; [ -z "$DB_USER" ] && DB_USER="inatrace_test_dufer"
          FE_URL="${{ secrets.TEST_DUFER_FE_URL }}"; [ -z "$FE_URL" ] && FE_URL="https://inatrace-test.empacadoradufer.com"
          MAIL_HOST="${{ secrets.TEST_DUFER_MAIL_HOST }}"; [ -z "$MAIL_HOST" ] && MAIL_HOST="mail.atijaguar.com"
          MAIL_PORT="${{ secrets.TEST_DUFER_MAIL_PORT }}"; [ -z "$MAIL_PORT" ] && MAIL_PORT="465"
          MAIL_USER="${{ secrets.TEST_DUFER_MAIL_USERNAME }}"; [ -z "$MAIL_USER" ] && MAIL_USER="desarrollo@atijaguar.com"
          cat > .env <<EOF
          IMAGE_NAME=$IMAGE
          TAG=$TAG
          DATABASE_NAME=inatrace_test_dufer
          DB_ROOT_PASSWORD=${{ secrets.TEST_DUFER_DB_ROOT_PASSWORD }}
          DATASOURCE_USERNAME=$DB_USER
          DATASOURCE_PASSWORD=${{ secrets.TEST_DUFER_DATASOURCE_PASSWORD }}
          CONTAINER_NAME_BE=inatrace-be-test-dufer
          CONTAINER_NAME_DB=inatrace-mysql-test-dufer
          HOST_PORT_BE=8080
          HOST_PORT_DB=3306
          FILE_STORAGE_ROOT=/opt/inatrace/uploads
          IMPORT_PATH=/opt/inatrace/import
          DOCUMENTS_ROOT=/opt/inatrace/documents
          FILE_STORAGE_ROOT_VOL=/opt/inatrace/uploads
          IMPORT_PATH_VOL=/opt/inatrace/imports
          DOCUMENTS_ROOT_VOL=/opt/inatrace/documents
          DB_VOLUME=/opt/inatrace/mysql
          FE_URL=$FE_URL
          FE_CONFIRM_URL=${FE_URL}/confirm-email/
          FE_RESET_URL=${FE_URL}/reset-password/
          SPRING_MAIL_HOST=$MAIL_HOST
          SPRING_MAIL_PORT=$MAIL_PORT
          SPRING_MAIL_USERNAME=$MAIL_USER
          SPRING_MAIL_PASSWORD=${{ secrets.TEST_DUFER_MAIL_PASSWORD }}
          SPRING_MAIL_SMTP_AUTH=true
          SPRING_MAIL_SMTP_SSL_ENABLE=true
          INATRACE_MAIL_SENDING_ENABLED=true
          EOF

      - name: üì§ Upload .env
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_DUFER_HOST }}
          username: ${{ secrets.TEST_DUFER_USER }}
          password: ${{ secrets.TEST_DUFER_PASSWORD }}
          source: ".env"
          target: "/opt/inatrace/backend/test/dufer/"

      - name: üöÄ Deploy Staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TEST_DUFER_HOST }}
          username: ${{ secrets.TEST_DUFER_USER }}
          password: ${{ secrets.TEST_DUFER_PASSWORD }}
          script: |
            set -e
            cd /opt/inatrace/backend/test/dufer
            
            echo "üîó Ensuring network..."
            docker network inspect inatrace-backend-network >/dev/null 2>&1 || docker network create inatrace-backend-network
            
            echo "üì• Pulling image..."
            docker-compose pull backend
            
            echo "üõë Stopping old containers..."
            docker stop inatrace-be-test-dufer 2>/dev/null || true
            docker rm inatrace-be-test-dufer 2>/dev/null || true
            
            echo "üöÄ Starting..."
            docker-compose up -d --no-deps --force-recreate backend
            
            echo "‚è≥ Health check..."
            for i in {1..12}; do
              sleep 10
              if curl -sf http://localhost:8080/actuator/health; then
                echo "‚úÖ DUFER Staging deployed!"
                exit 0
              fi
              echo "  Attempt $i/12..."
            done
            
            echo "‚ùå Health check failed"
            docker logs inatrace-be-test-dufer --tail 50
            exit 1

  # ============================================================================
  # Deploy Production
  # ============================================================================
  deploy-production:
    name: üöÄ Deploy DUFER Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment:
      name: dufer-production
      url: https://inatrace.empacadoradufer.com
    steps:
      - uses: actions/checkout@v4

      - name: üîê Preflight
        run: |
          missing=0
          [ -z "${{ secrets.PROD_DUFER_HOST }}" ] && echo "‚ùå PROD_DUFER_HOST" && missing=1
          [ -z "${{ secrets.PROD_DUFER_USER }}" ] && echo "‚ùå PROD_DUFER_USER" && missing=1
          [ -z "${{ secrets.PROD_DUFER_PASSWORD }}" ] && echo "‚ùå PROD_DUFER_PASSWORD" && missing=1
          [ -z "${{ secrets.PROD_DUFER_DB_ROOT_PASSWORD }}" ] && echo "‚ùå PROD_DUFER_DB_ROOT_PASSWORD" && missing=1
          [ -z "${{ secrets.PROD_DUFER_DATASOURCE_PASSWORD }}" ] && echo "‚ùå PROD_DUFER_DATASOURCE_PASSWORD" && missing=1
          [ "$missing" -ne 0 ] && exit 1
          echo "‚úÖ All secrets present"

      - name: üìÅ Prepare remote directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_DUFER_HOST }}
          username: ${{ secrets.PROD_DUFER_USER }}
          password: ${{ secrets.PROD_DUFER_PASSWORD }}
          script: |
            mkdir -p /opt/inatrace/deploy/backend/prod/dufer

      - name: üì§ Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_DUFER_HOST }}
          username: ${{ secrets.PROD_DUFER_USER }}
          password: ${{ secrets.PROD_DUFER_PASSWORD }}
          source: "deploy/backend/prod/dufer/docker-compose.yml"
          target: "/opt/inatrace/deploy/backend/prod/dufer"

      - name: üìù Prepare .env
        run: |
          IMAGE="${{ needs.build.outputs.image-ref }}"
          TAG="${{ needs.build.outputs.image-tag }}"
          DB_USER="${{ secrets.PROD_DUFER_DATASOURCE_USERNAME }}"; [ -z "$DB_USER" ] && DB_USER="inatrace_prod_dufer"
          FE_URL="${{ secrets.PROD_DUFER_FE_URL }}"; [ -z "$FE_URL" ] && FE_URL="https://inatrace.empacadoradufer.com"
          MAIL_HOST="${{ secrets.PROD_DUFER_MAIL_HOST }}"; [ -z "$MAIL_HOST" ] && MAIL_HOST="mail.atijaguar.com"
          MAIL_PORT="${{ secrets.PROD_DUFER_MAIL_PORT }}"; [ -z "$MAIL_PORT" ] && MAIL_PORT="465"
          MAIL_USER="${{ secrets.PROD_DUFER_MAIL_USERNAME }}"; [ -z "$MAIL_USER" ] && MAIL_USER="desarrollo@atijaguar.com"
          cat > .env <<EOF
          IMAGE_NAME=$IMAGE
          TAG=$TAG
          DATABASE_NAME=inatrace_prod_dufer
          DB_ROOT_PASSWORD=${{ secrets.PROD_DUFER_DB_ROOT_PASSWORD }}
          DATASOURCE_USERNAME=$DB_USER
          DATASOURCE_PASSWORD=${{ secrets.PROD_DUFER_DATASOURCE_PASSWORD }}
          FILE_STORAGE_ROOT=/opt/inatrace/uploads
          IMPORT_PATH=/opt/inatrace/import
          DOCUMENTS_ROOT=/opt/inatrace/documents
          FE_URL=$FE_URL
          FE_CONFIRM_URL=${FE_URL}/confirm-email/
          FE_RESET_URL=${FE_URL}/reset-password/
          SPRING_MAIL_HOST=$MAIL_HOST
          SPRING_MAIL_PORT=$MAIL_PORT
          SPRING_MAIL_USERNAME=$MAIL_USER
          SPRING_MAIL_PASSWORD=${{ secrets.PROD_DUFER_MAIL_PASSWORD }}
          SPRING_MAIL_SMTP_AUTH=true
          SPRING_MAIL_SMTP_SSL_ENABLE=true
          INATRACE_MAIL_SENDING_ENABLED=true
          EOF

      - name: üì§ Upload .env
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_DUFER_HOST }}
          username: ${{ secrets.PROD_DUFER_USER }}
          password: ${{ secrets.PROD_DUFER_PASSWORD }}
          source: ".env"
          target: "/opt/inatrace/deploy/backend/prod/dufer"

      - name: üíæ Pre-deploy DB Backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_DUFER_HOST }}
          username: ${{ secrets.PROD_DUFER_USER }}
          password: ${{ secrets.PROD_DUFER_PASSWORD }}
          script: |
            CN=inatrace-mysql-prod-dufer
            if docker ps --format '{{.Names}}' | grep -q "^$CN$"; then
              echo "üì¶ Running DB backup..."
              docker exec "$CN" sh -c 'mysqldump -u root -p"$MYSQL_ROOT_PASSWORD" "$MYSQL_DATABASE" | gzip > /backups/backup-$(date +%Y%m%d-%H%M%S).sql.gz'
              docker exec "$CN" sh -c 'find /backups -name "backup-*.sql.gz" -mtime +14 -delete'
            else
              echo "‚ö†Ô∏è MySQL container not found, skipping backup"
            fi

      - name: üöÄ Deploy Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_DUFER_HOST }}
          username: ${{ secrets.PROD_DUFER_USER }}
          password: ${{ secrets.PROD_DUFER_PASSWORD }}
          script: |
            set -e
            cd /opt/inatrace/deploy/backend/prod/dufer
            
            echo "üîó Ensuring network..."
            docker network inspect inatrace-backend-dufer-network >/dev/null 2>&1 || docker network create inatrace-backend-dufer-network
            
            echo "üì¶ Loading image..."
            docker-compose pull || true
            
            echo "üöÄ Deploying..."
            docker-compose up -d --remove-orphans
            
            echo "‚è≥ Health check..."
            for i in {1..12}; do
              sleep 10
              if curl -sf https://inatrace.empacadoradufer.com/api/actuator/health; then
                echo "‚úÖ DUFER Production deployed!"
                exit 0
              fi
              echo "  Attempt $i/12..."
            done
            
            echo "‚ùå Health check failed"
            exit 1
